@using MovieFiles.Core.Models
@using MovieFiles.Api.Client.Services
@using Microsoft.AspNetCore.Diagnostics
@inject IMoviesService MoviesService
@inject IJSRuntime JSRuntime


<div class="movies-container">
    @foreach (var movie in MovieList.Results)
    {
        <Movie Movie="@movie"></Movie>
    }
    @* </Virtualize> *@
</div>



<ul id="page-list">
    <li @onclick="First">
        «
    </li>
    @for (int i = @Page - @PageRange; i <= @Page + @PageRange; i++)
    {
        if (i >= 1 && i <= @TotalPages)
        {
            var pageI = i;
            if (i == @Page)
            {
                <li class="active" @onclick="() => OnClick(pageI)">
                    @pageI
                </li>
            }
            else
            {
                <li class="" @onclick="() => OnClick(pageI)">
                    @pageI
                </li>
            }
        }
    }
    <li @onclick="Last">
        »
    </li>
</ul>


@code{
    public MovieList MovieList = new MovieList(12);
    public int Page { get; set; } = 1;
    [Parameter]
    public Func<int,Task<MovieList>>? MovieGetter {get;set;}
    public static readonly int TotalPages = 500;
    public static readonly int PageRange = 3;

    public bool reRender { get; set; } = false;
    protected override async Task OnInitializedAsync()
    {
        this.Page = Math.Max(1, this.Page);
        if (MovieGetter != null){
            MovieList = await MovieGetter(Page);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        this.Page = Math.Max(1, this.Page);
        if (MovieGetter != null){
            MovieList = await MovieGetter(Page);
        }
    }

    async Task OnClick(int id)
    {
        if (Page != id)
        {
            Page = id;
            reRender = true;
            MovieList = await MoviesService.GetPopularMoviesAsync(Page);
        }
    }

    async Task First()
    {
        Page = 1;
        reRender = true;
        MovieList = await MoviesService.GetPopularMoviesAsync(Page);
    }
    async Task Last()
    {
        Page = TotalPages;
        reRender = true;
        MovieList = await MoviesService.GetPopularMoviesAsync(Page);
    }

}